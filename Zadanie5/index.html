<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>IndexedDB</title>
	<style>
<!--CSS-->
table, th, td {
  border: 1px solid black;
}
</style>
</head>
<body>
    <p>
        <fieldset id="addForm">
            <legend>Add New User</legend>
            <label>First Name</label>
            <input id="nameInput">
            <label>LastName</label>
            <input id="lastName">
            <button id="addButton">Add</button>
        </fieldset>
    </p>

    <table id="contacts" borde="1px">
        <thead>
            <tr><th>Name</th><th>Last Name</th></tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>

        var indexedDB = window.indexedDB ||
                        window.webkitIndexedDB ||
                        window.mozIndexedDB;

        function DB(name) {
            this.init = function(version, upgrade, done) {
                console.log('init');
                var openReq = indexedDB.open(name, version);
                openReq.onsuccess = function(e) {
                    var db = e.target.result;
                    if ('setVersion' in db && db.version < version) {
                        var setVerReq = db.setVersion(version);
                        setVerReq.onsuccess = function(e) {
                            console.log('upgrading');
                            upgrade(e.target.result.db);
                            done();
                        };
                    } else {
                        done();
                    }
                };
                openReq.onupgradeneeded = function(e) {
                    console.log('upgrading');
                    upgrade(e.target.result);
                };
                openReq.onerror = function(e) {
                    console.log('init error');
                };
                openReq.onblocked = function(e) {
                    console.log('init blocked');
                };
            };

            this.read = function(stores, fn, done) {
                return this.transaction('readonly', stores, fn, done);
            };

            this.readWrite = function(stores, fn, done) {
                return this.transaction('readwrite', stores, fn, done);
            };

            this.transaction = function(mode, stores, fn, done) {
                var openReq = indexedDB.open(name);
                openReq.onsuccess = function(e) {
                    var db = e.target.result;
                    var tx = db.transaction(stores, mode);
                    tx.oncomplete = function(e) {
                        if (done) {
                            done();
                        }
                    };
                    tx.onabort = function(e) {
                        console.log('tx abort');
                    };
                    tx.onerror = function(e) {
                        console.log('tx error');
                    };
                    fn(tx);
                };
                openReq.onerror = function(e) {
                    console.log('open tx error');
                };
            };
        }

        DB.deleteDatabase = function(name, done) {
            var delReq = indexedDB.deleteDatabase(name);
            delReq.onsuccess = function(e) {
                done();
            };
            delReq.onerror = function(e) {
                console.log('delete error');
            };
            delReq.onblocked = function(e) {
                console.log('delete blocked');
            };
        };
    </script>

    <script>

        var databaseName = 'ContactsDB';
        var contactsStoreName = 'contacts';

        var contactsDB = new DB(databaseName);

        var contacts = document.getElementById('contacts');

        contactsDB.init(1, function(db) {
            db.createObjectStore(contactsStoreName, {
                autoIncrement: true
            });
        }, function() {
            console.log('ready');

            loadContactsTable();
        });

        function loadContactsTable() {
            contactsDB.read([ contactsStoreName ], function(tx) {
                var cursor = tx.objectStore(contactsStoreName).openCursor();
                cursor.onsuccess = function(e) {
                    if (e.target.result) {
                        addContactToTable(e.target.result.value);
                        e.target.result.continue();
                    }
                };
                cursor.onerror = function(e) {
                    console.log('cursor error');
                };
            });
        }

        function addContactToTable(contact) {
            var newRow = contacts.insertRow(-1);
            var nameCell = newRow.insertCell(-1);
            nameCell.textContent = contact.name;
            var lastNameCell = newRow.insertCell(-1);
            lastNameCell.textContent = contact.last;
        }
        
        var nameInput = document.getElementById('nameInput');
        var lastNaem = document.getElementById('lastName');

        document.getElementById('addButton').onclick = function(e) {
            e.preventDefault();

            var name = nameInput.value;
            var last = lastName.value;

            console.log('adding');

            contactsDB.readWrite([ contactsStoreName ], function(tx) {
                var contact = {

                    name: name,
                    last: last
                };

                tx.objectStore(contactsStoreName).put(contact);

                addContactToTable(contact);
            }, function() {
                console.log('added');

                nameInput.value = '';
                lastName.value = '';

                nameInput.focus();
            });
        };
    </script>
</body>
</html>
